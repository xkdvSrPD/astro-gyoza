name: Deploy Astro to DogeCloud

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup pnpm
      uses: pnpm/action-setup@v3
      with:
        version: latest
        
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'pnpm'
        
    - name: Install dependencies
      run: pnpm install --frozen-lockfile
      
    - name: Build Astro project
      run: pnpm run build
      
    - name: Upload to DogeCloud COS
      uses: zu1k/dogecloud-cos-action@v0.1.3
      with:
        access_key: ${{ secrets.ACCESS_KEY }}
        secret_key: ${{ secrets.SECRET_KEY }}
        bucket: ${{ secrets.BUCKET }}
        region: ${{ secrets.REGION }}
        local_path: dist
        remote_path: /
        clean: true
        accelerate: true
        
    - name: Refresh DogeCloud CDN Cache
      env:
        ACCESS_KEY: ${{ secrets.ACCESS_KEY }}
        SECRET_KEY: ${{ secrets.SECRET_KEY }}
        DOMAIN: ${{ secrets.DOMAIN }}
      run: |
        python3 << 'EOF'
        import hmac
        import hashlib
        import requests
        import json
        import urllib.parse
        import os
        
        # é…ç½®
        access_key = os.environ['ACCESS_KEY']
        secret_key = os.environ['SECRET_KEY']
        domain = os.environ['DOMAIN']
        
        # APIè°ƒç”¨å‡½æ•°
        def dogecloud_api(api_path, data={}):
            body = urllib.parse.urlencode(data)
            sign_str = api_path + "\n" + body
            sign = hmac.new(
                secret_key.encode('utf-8'),
                sign_str.encode('utf-8'),
                hashlib.sha1
            ).hexdigest()
            
            headers = {
                'Authorization': f"TOKEN {access_key}:{sign}",
                'Content-Type': 'application/x-www-form-urlencoded'
            }
            
            response = requests.post(
                f"https://api.dogecloud.com{api_path}",
                data=body,
                headers=headers
            )
            return response.json()
        
        # åˆ·æ–°CDNç¼“å­˜
        print(f"ðŸ”„ åˆ·æ–°åŸŸå {domain} çš„CDNç¼“å­˜...")
        result = dogecloud_api('/cdn/refresh/add.json', {
            'rtype': 'path',
            'urls': f"{domain}/*"
        })
        
        if result.get('code') == 200:
            print(f"âœ… CDNç¼“å­˜åˆ·æ–°æˆåŠŸï¼Œä»»åŠ¡ID: {result.get('data', {}).get('task_id', 'N/A')}")
        else:
            print(f"âŒ CDNç¼“å­˜åˆ·æ–°å¤±è´¥: {result.get('msg', 'æœªçŸ¥é”™è¯¯')}")
            exit(1)
        EOF
        
    - name: Deployment Complete
      run: echo "ðŸŽ‰ éƒ¨ç½²å®Œæˆï¼"